<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://toflamus.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://toflamus.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-05-13T18:12:56+00:00</updated><id>https://toflamus.github.io/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html"></title><link href="https://toflamus.github.io/blog/2024/2024-04-29-Battery-Managment-Systems/" rel="alternate" type="text/html" title=""/><published>2024-05-13T18:12:56+00:00</published><updated>2024-05-13T18:12:56+00:00</updated><id>https://toflamus.github.io/blog/2024/2024-04-29-Battery-Managment-Systems</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/2024-04-29-Battery-Managment-Systems/"><![CDATA[<h2 id="an-introduction-to-bms">An introduction to BMS</h2> <p>The scale of the book is mainly on how to manage battery system, involves the hardware and software parts. The software part is stressed by different algorithms to model the battery packs.</p> <blockquote> <p>Definition of <em>Battery management(monitoring) systems(BMS)</em>: A permanently installed system(embeded) for measuring, storing and reporting battery parameters.<br/> –IEEE Standard 1491.</p> </blockquote> <p>Purposes:</p> <ol> <li>To protect the safety of operator and system components.</li> <li>To prolong the life of the batteries.</li> <li>To keep the battery functioning.</li> </ol> <p>Marginal effect: When do we need BMS？</p> <p>Cost of failure(Expectation) and related cost higher than then cost of BMS.</p> <p>Important in such cases:</p> <ul> <li><em>Hybrid-electric vehicles(HEVs)</em>: Never charge its batteries by a blug. The BMS combines the gasoline engine and make full use of the energy.</li> <li><em>Plug-in HEVs(PHEVs)</em>: It can opertate in electric only mode and prosess a larger battery pack. <ul> <li>Charge-depletion mode: Just use electricity to operate.</li> <li>Charge-sustaining mode: When the battery is nearly empty, it starts to work like HEVs.</li> </ul> </li> <li><em>Extend-range electric vehicles(REVs)</em>: Small gasoline engine and large battery pack. Can operate just like EVs. When the battery runs out of capacity, the gasoline engine provides <em>extended range</em>.</li> <li> <p><em>EVs</em>: Battery-electric vehicles.</p> </li> <li>Grid storage powers, telecoms off-grid power.</li> </ul> <h2 id="battery-pack-topology">Battery-pack topology</h2> <p>Topology is a branch of mathematics that deals with the properties of space that are preserved under continuous deformations, such as stretching, crumpling, and bending, but not tearing or gluing.</p> <p>However, here the word topology refers to how to construct a battery pack. Taking the EVs as an example, a EV generally needs high voltage and large current density.</p> <p>High voltage can be achieved by placing the batteries in series, a <em>series-cell-module(SCM)</em>. While large current density can be achieved by placing them in parallel, a <em>parallel-cell-module(PCM)</em>. However, they all have there defects like large inner resistances which may result in low current and low voltage, respectively.</p> <p>Consequently, there is a <strong>trade-off between series or parallel packing</strong>.</p> <p>However, in engineering practice, we usually build a complex system in modules. We first optimize the topology in a single module and then optimize the topology in modules combinations, so on and so forth. This methodology reduces NRE costs.</p> <p>For example, a classic <em>3P6S</em> module has 18 cells, 3 in parallel and 6 in series. The power and energy are then boteh approximately 18 times that of a single cell.</p> <h2 id="bms-design-requirements">BMS design requirements</h2> <ul> <li>Sensing and high-voltage control: $u,i,T$ monitoring.</li> <li>Protection: against overcharge, overdischarge, overcurrent, short circuits, extreme temperatures.</li> <li>Interface: report the status</li> <li>Performance management: SOC management…</li> <li>Diagnostics: (State of health)SOH, (State of life)SOL …</li> </ul> <h3 id="requirement1-battery-pack-sensing">Requirement1: Battery-pack sensing</h3> <h4 id="voltage">Voltage</h4> <p>Intergrated circuit are ofter used, such as LTC6803<br/> Basic structure: <em>Master-slave system</em></p> <p>When many cells are connected in series <em>high voltage isolation</em> is required but challenging.</p> <h4 id="temperature">Temperature</h4> <p>Battery-pack sensinig: <strong>Temperature</strong>: A model is needed to monitor the temperature inside the battery from external temperature.</p> <p><em>Thermocouple</em>: A thermocouple uses 2 different metals to contact and a tiny voltage generate from from the contact. The voltage can be amplified and measured. However, the measurement requires the a relative sample metal at a known temperature. In other words, it needs a reference state. This method is good for lab but not for production BMS designs.</p> <p><em>Themistor</em>: Resistor-temperature relationship.</p> <p><em>Resistance thermometers(resistance temperature detectorsRTD)</em>: Using resistance/temperature relationship of metals, generally pure materials(Cu, Ni, Pt), to detect temperature. Accurate, fragile. Mostly used in lab.</p> <p>A circuit is used to monitor the resistances of thermistor. Then you can look up to the table for the thermistor-temperature relationship.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/circuit-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/circuit-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/circuit-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/circuit.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h4 id="current">Current</h4> <p><em>Current-shunt</em>: Use a low-value($0.1m\Omega$), high-precision resistor. the $i = v_{shunt}/R_{shunt}$. The signal needs an amplifier to be detectable.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/currentshunt-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/currentshunt-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/currentshunt-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/currentshunt.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> The figure is from L.Plett's book.&lt;d-cite, key='BMS_vol2'&gt;&lt;\d-cite&gt; </div> <ul> <li>Pros: <ul> <li>No zero offset<d-footnote>This may refers to the semiconductor diode which has a threshold voltage to allow current to past through it like short circuit. </d-footnote> compared with hall-effect sensors, regradless of temperature(if the resistor do not vary with temperature).</li> </ul> </li> <li>Cons: <ul> <li>It needs an isolated power supply to support amplifiers.</li> <li>Generate slight amount of hear.</li> </ul> </li> </ul> <p><em>Hall-effect sensors</em>: Detect the magnetic field associated with a current flowing.<br/> A good <a href="https://www.allegromicro.com/en/insights-and-innovations/technical-documents/hall-effect-sensor-ic-publications/hall-effect-ic-applications-guide">web</a> about Hall-effect sensors.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/hall-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/hall-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/hall-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/hall.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> The figure is from L.Plett's book.&lt;d-cite, key='BMS_vol2'&gt;&lt;\d-cite&gt; </div> <ul> <li>Pros: <ul> <li>No isolated power supply.</li> </ul> </li> <li>Cons: <ul> <li>Zero-offset that is hard to calibrate.</li> <li>The zero offset is time and temperature dependent.</li> </ul> </li> <li>Protection: against overcharge, overdischarge, overcurrent, short circuits, extreme temperatures.</li> <li>Interface: report the status</li> <li>Performance management: SOC management…</li> <li>Diagnostics: (State of health)SOH, (State of life)SOL …</li> </ul> <h4 id="high-voltage-contactor-control">High-voltage contactor control</h4> <p>The thing is that most of battery loads are often capacitive, before it can function, a charging process will be started first. If you just use a pure contactor at the starting point the contactor may get fused.</p> <p>So a pre-contrator with a resistor is needed. Just to control the charging process not to be too fast with extreme large current.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/precontactor-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/precontactor-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/precontactor-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/precontactor.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> (a)-(e) demonstrate the process to start charging a device. &lt;d-cite, key='BMS_vol2'&gt;&lt;\d-cite&gt; </div> <h4 id="isolation-sensing">Isolation sensing</h4> <p>Just take a the lead-acid battery in an car as an example. The voltage of the battery is 12V and it is directly installed on the chassis. Though the battery has a package and a totally invisable circuit away from people. However, no one can make sure when there is an accident, the chassis do not connect to one of the electrodes of the battery.</p> <p>In a large battery pack, the DC bus voltage can be in the range of <strong>300~800V</strong>. Consequently, there is a requirement to detect it is shunt or not with chassis. A safety current limit is <strong>0.2mV</strong>.</p> <p>A circuit is required to estimates the isolation resistance on each side of the pack.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/isolationdetect-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/isolationdetect-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/isolationdetect-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/isolationdetect.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Isolation detect circuit &lt;d-cite, key='C26_2'&gt;&lt;\d-cite&gt; </div> <h3 id="requirement4-energy-and-power-estimation">Requirement4: Energy and power estimation</h3> <p>There are only 3 parameters that we know the temperature current and voltage of battery $i$ in the $k^{th}$ time step,$v_k^{(i)}, i_k^{(i)}, T_k^{(i)}$</p> <p>However we need SOC($z_k^{i}$), SOV, remaining capacity$Q_k^{i}$ and inner reisistance$R_k^{i}$ to get energy and power abailable in the next period of time.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-29-Battery-Managment-Systems/EandPestimationwf-480.webp 480w,/assets/img/2024-04-29-Battery-Managment-Systems/EandPestimationwf-800.webp 800w,/assets/img/2024-04-29-Battery-Managment-Systems/EandPestimationwf-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-29-Battery-Managment-Systems/EandPestimationwf.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Energy and power estimation workflow &lt;d-cite, key='BMS_vol2'&gt;&lt;\d-cite&gt; </div> <h4 id="soc-estimation">SOC estimation</h4> <p>I will do this part in the future</p> <h4 id="energy-estimation">Energy estimation</h4> <p>I will do this part in the future</p> <h4 id="power-estimation">Power estimation</h4> <p>I will do this part in the future</p> <h2 id="afternotes">Afternotes</h2> <p><em>Non-Recurring Engineering(NRE)</em>: Non-Recurring Engineering is the cost of creating a new product and is usually fully paid before any product gets manufactured. This is in contrast with production cost, which is an ongoing cost and is generally based on the quantities produced. For example, in the camera lens industry, the NRE would be the cost of developing the lens designs and tools which will make the lens smooth; the production cost would be the cost to manufacture each camera lens.</p> <p><em>Contactor</em> A contactor is an electrically controlled switch used for switching an electrical power circuit. A contactor is typically controlled by a circuit which has a much lower power level than the switched circuit, such as a 24-volt coil electromagnet controlling a 230-volt motor switch.</p> <p><em>Amplifier(amp)</em>:An amplifier, electronic amplifier or (informally) amp is an electronic device that can increase the magnitude of a signal (a time-varying voltage or current). It is a two-port electronic circuit that uses electric power from a power supply to increase the amplitude (magnitude of the voltage or current) of a signal applied to its input terminals, producing a proportionally greater amplitude signal at its output.<a href="https://en.wikipedia.org/wiki/Amplifier">from wikipedia:</a> This is a kind of <em>active devices</em>(provide outpurs containing more power than their inputs), which means they need extra power supply.</p> <p><em>Common mode rejection ratio (CMRR)</em> of amp: <a href="https://en.wikipedia.org/wiki/Common-mode_rejection_ratio">wikipedia</a></p> <p><em>Analog-to-digital converter (ADC)</em> The device to convert a <strong>continuous</strong> analog signal(sound wave or sth) to a <strong>discrete</strong> digital signal. It involves some issure with sampling frequency, above which the information loss and <em>aliasing</em> may rise. The sample rate is determined by <em>Nyquist-Shannon sampling theorem</em>.</p> <p><em>Bus voltage</em> is the total voltage between power and ground(GND). It is the sum of the load voltage and the shunt voltage.<br/> <em>Load voltage</em> is the voltage going to the load. <em>Shunt voltage</em> is the voltage drop across the shunt resistor that is in series with the load.</p> <p><em>chassis</em>(ʃæ̱si) A <em>chassis</em> is the framework that a vehicle is built on.</p> <p>现在感觉真是越看不懂的越多，对于amp和hall element都有一个叫做zero offset的东西。 这个东西好像很深奥，然后对于不同的材料对于这个offset的modeling也不同。只能从主干入手了。旁支末节聊记于此，有心时再研究吧。</p>]]></content><author><name></name></author></entry><entry><title type="html">Mass transfer and diffusion</title><link href="https://toflamus.github.io/blog/2024/ff_mt/" rel="alternate" type="text/html" title="Mass transfer and diffusion"/><published>2024-05-13T09:00:00+00:00</published><updated>2024-05-13T09:00:00+00:00</updated><id>https://toflamus.github.io/blog/2024/ff_mt</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/ff_mt/"><![CDATA[<h2 id="basic-concepts-and-definitions">Basic concepts and definitions</h2> <p>Before we start let just review some concepts:</p> <p>There are 2 kinds of diffusion we consider in the system.</p> <p><em>molecular diffusion</em> by <strong>random and spontaneous microscpoic movement of molecules</strong> of thermo motion occurs in fluid that is <strong>stagnant or in laminar motion</strong>. The process is <strong>slow</strong>.<br/> <em>eddy diffusion</em> by <strong>random macroscopic fluid motion</strong> occurs when <strong>fluid mixing in a turbulent motion</strong>. This is a fast process.</p> <p>Also, mass transfer contains convection.<em>convection</em> by bulk flow.</p> <p>$J$: molar diffusion flux density<br/> $N$：molar flux density</p> <h3 id="species-velocities">Species velocities</h3> <h2 id="ficks-law-and-mass-balance">Fick’s law and mass balance</h2> <p>To start with, if we do not go from <em>Maxwell-Stefan’s theory</em> everything starts with 2 basic thoughts. We use different forms of the 2 equations here and there. Please remember this in your mind <strong>Mass transport analogues to heat transfer</strong> in many ways!</p> <h3 id="ficks-law-and-mutual-diffusivity">Fick’s law and mutual diffusivity</h3> <p>We just assume that a driving force result in a linear responding. Which is exactly the <em>Fick’s law</em><br/> \begin{equations} J_A = -D_{AB}\nabla c_A \end{equations}</p> <p>\(J_B = -D_{BA}\nabla c_B\) \(D_{AB} = D_{BA}\)</p> <p>$D$ is in $m^2/s$, $c$ is in $[anyunit]/m^3$</p> <p>There are other forms of Fick’s law:<br/> \(J_A = -cD_{AB}\nabla x_A\) or<br/> \(j_A = -\rho D_{AB}\nabla w_A\) $w_A$ is the mass fraction of A. $\rho * w = kg/m^3* kg(A)/kg(solution) = m_A/v_{solution}$</p> <h3 id="mass-balance-in-a-control-volume">Mass balance in a control volume</h3> <p>Consider a classic mass balance problem in a controled volume.</p> \[\frac{\partial c_A}{\partial t} = \nabla\] <h3 id="ficks-second-law">Fick’s second law</h3> <p>Combine the first 2 equations, we have the Fick’s second law:</p> <p>$\frac{\partial c_A}{\partial t} = - \nabla^2 c_A$</p> <p>Film theroy</p> <p>Stagnent layer of a laminar sublayer (层流边界层的传质)<br/> Phase equilibrium which means that there is a sharp change of concentration in the boundary of film. Approximation of Fick’s law</p>]]></content><author><name></name></author><category term="masstransfer"/><category term="masstransfer"/><summary type="html"><![CDATA[Introduction to fluid-fluid mass transfer with comparison between different models and an introduction to Maxwell Stefan law]]></summary></entry><entry><title type="html">A detailed example of Fast Fourier Transform</title><link href="https://toflamus.github.io/blog/2024/fft/" rel="alternate" type="text/html" title="A detailed example of Fast Fourier Transform"/><published>2024-05-02T09:00:00+00:00</published><updated>2024-05-02T09:00:00+00:00</updated><id>https://toflamus.github.io/blog/2024/fft</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/fft/"><![CDATA[<h2 id="discrete-fourier-transform">Discrete Fourier Transform</h2> <p>I suppose nobody can get away of Discrete Fourier Transform(DFT) when talking about Fast Fourier Transform(FFT). Let’s have a quick look.</p> <p>A DFT comes from continuous Fourier Transform:</p> \[\hat f(\omega) = \mathscr{F}\{f(t)\} = \int_{-\infty}^{+\infty} f(\tau) e^{-i\omega t} dt\] <p>For a discrete version of FT:</p> \[\hat f[k] = \frac{1}{N}\sum_{n=0}^{N-1}f[n]e^{-\frac{2\pi i k n }{N}}\] <p>Take a detailed look at the $k = 0$ case.</p> <p>\(\hat f[k = 0] = \frac{1}{N}(f[0]+f[1]+f[2]+...+f[N-1])\) \(\hat f[k = 0] = \frac{1}{N}\sum_{n=0}^{N-1} = \mu = mean\)</p> <p>In the background of circuit, this $k = 0$ term is also called a DC-offset.</p> <p>\(\hat f[k = 1] = \frac{1}{N}(f[0]+f[1]e^{(\frac{-2\pi i }{N})}+f[2]e^{(\frac{-4\pi i }{N})}+...+f[N-1]e^{(\frac{-2\pi i (N-1)}{N})})\) \(\hat f[k = 2] = \frac{1}{N}(f[0]+f[1]e^{(\frac{-2*2\pi i }{N})}+f[2]e^{(\frac{-2*4\pi i }{N})}+...+f[N-1]e^{(\frac{-2\pi i 2* (N-1)}{N})})\)<br/> \(\hat f[k = m] = \frac{1}{N}(f[0]+f[1]e^{(\frac{-m*2\pi i }{N})}+f[2]e^{(\frac{-m*4\pi i }{N})}+...+f[N-1]e^{(\frac{-2\pi i m* (N-1)}{N})})\)</p> <p>If we define the <em>Fundamental Frequency</em>:</p> \[W_N = e^{-\frac{2\pi i }{N}}\] <p>Maybe you have noticed that $W_N$ is the last solution to the polinomial equation:</p> \[x^N = 1\] <p>Anyway, the DFT now becomes:</p> \[\hat f[k] = \frac{1}{N}\sum_{n=0}^{N-1}f[n]W_N^{kn}\] <p>In a matrix form:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/DFT-480.webp 480w,/assets/img/2024-05-02-fft/DFT-800.webp 800w,/assets/img/2024-05-02-fft/DFT-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/DFT.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>If we calculate DFT in this way, the time complexity is $O(N^2)$.</p> <h2 id="fft-with-an-8-point-example">FFT with an 8-point example</h2> <p>One may notice that there are so many $W_N$ in the matrix, we calculate them again and again, and it there any way that we can make life easier and reuse the data we have calculated before. Recursively, we can divide the equation into <em>odd</em> and <em>even</em> components and they have the same factor and we can re-divide the equation into sub-<em>odd</em> and sub-<em>even</em> components and so on and so forth. This could result in a beautiful algorithm that can be explained with a butterfly diagram. Do not panic if you cannot understand what I am saying, I will explain this with an 8-point example.</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p1-480.webp 480w,/assets/img/2024-05-02-fft/8p1-800.webp 800w,/assets/img/2024-05-02-fft/8p1-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>I delibrately write the equation in a form of even and odd terms.</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p2-480.webp 480w,/assets/img/2024-05-02-fft/8p2-800.webp 800w,/assets/img/2024-05-02-fft/8p2-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Now the odd and even term has a same factor.</p> <p>The $e^{-\frac{2\pi i k}{8}}$ is called <em>twiddle factor</em>.</p> <p>\(W_t = W_M^k\)<br/> You will see that the $M$ will be divided from N by a factor of 2 every time we separate the odd and even terms. <strong>Please note that there is a important $k$ thing in the exponential term</strong>, which actually causes more trouble to understand the FFT. I did not notice that at first and thought I understood FFT. However, when going over the whole materials, I noticed that k thing and realised that I just did not understand FFT.</p> <p>We can do the same thing 2 more times:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p3-480.webp 480w,/assets/img/2024-05-02-fft/8p3-800.webp 800w,/assets/img/2024-05-02-fft/8p3-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Notice in the exponential term, we can divide both numerator and denominator by a 2.</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p4-480.webp 480w,/assets/img/2024-05-02-fft/8p4-800.webp 800w,/assets/img/2024-05-02-fft/8p4-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Get new twiddle factor out:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p5-480.webp 480w,/assets/img/2024-05-02-fft/8p5-800.webp 800w,/assets/img/2024-05-02-fft/8p5-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Divide both numerator and denominator by a 2.</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p6-480.webp 480w,/assets/img/2024-05-02-fft/8p6-800.webp 800w,/assets/img/2024-05-02-fft/8p6-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p6.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Ok, now the last time:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p7-480.webp 480w,/assets/img/2024-05-02-fft/8p7-800.webp 800w,/assets/img/2024-05-02-fft/8p7-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Not the $log_2N^th$ twiddle factor is $e^{-\frac{2\pi i 0* k}{1}} = 1$. So now the thing becomes to:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p8-480.webp 480w,/assets/img/2024-05-02-fft/8p8-800.webp 800w,/assets/img/2024-05-02-fft/8p8-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p8.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Rearrange them:</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p9-480.webp 480w,/assets/img/2024-05-02-fft/8p9-800.webp 800w,/assets/img/2024-05-02-fft/8p9-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p9.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>For those who have seen the butterfly diagram probably will shout out: <em>Oh that is the butterfly thing!</em> (That is what I did at the first time learning this topic). Do not forget the $k$ in the exponential! What does it mean? It means that for every $k$, the computer needs to go through every calculation one time. Beacuse the $k$ value varies and we need to compute everything again when meet a new $k$. Besides what we did just now is just doing rearrangement and this doesn’t relieve any of the computational complexity. So the time complexity till now is still $O(N^2)$. <strong>What the butterfly diagram tells us is that we can resuse the results at each stage(the separation of odd and even terms)</strong>. But what we have acchieved cannot promise that.</p> <p>Now we comes to the most important part(I think because I spend days of time to figure out what’s gonna be next)</p> <h2 id="how-to-read-a-butterfly-diagram">How to read a butterfly diagram</h2> <p>Next we will work through the whole thing with butterfly diagram as a reference. So let’s read it first.</p> <ul> <li>Each line(or arrow) is a multiplication by a factor(a constant)</li> <li>Each dot(end points of 2 lines) is an addition</li> <li>Each branch(start points of 2 branches) means the value after multiplication can go either way.</li> </ul> <p>Actually this graph clearly demostrates that the time complexity is $NlogN$. With the stage number of $log(N)$ and $N ‘+’ and N ‘*’$ at each stage.</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/butterfly-480.webp 480w,/assets/img/2024-05-02-fft/butterfly-800.webp 800w,/assets/img/2024-05-02-fft/butterfly-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/butterfly.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> A butterfly diagram.<d-cite key="C25_2"></d-cite></div> <h2 id="connections-with-butterfly-diagramthe-elimination-of-k-in-twiddle-factors">Connections with butterfly diagram–the elimination of k in twiddle factors</h2> <p>Let’s re-look at the following equation:<br/> I delibrately write the equation in a form of even and odd terms.</p> <div class="row mt-5"> <div class="col-sm mt-5 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/8p9-480.webp 480w,/assets/img/2024-05-02-fft/8p9-800.webp 800w,/assets/img/2024-05-02-fft/8p9-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/8p9.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>For the $3^{rd}$ stage(the second left column), the twiddling factor is $W_{t3} = W_2 = e^{-\frac{2\pi i k}{2}}$</p> <p>\(W_{t3} = 1, k = even number\) \(W_{t3} = -1, k = odd number\)</p> <p>So no matter the $k$ in the third stage there can only be 2 options for a 2 point DFT. We can reuse the data in the first stage!</p> <p>Now let’s construct the butterfly diagram:</p> <p>If $k$ is even, we let the 0-4, 2-6, 1-5, 3-7 pair to combine and calculate a value and put it in the upper place, just as the red lines.</p> <p>Vice versa, if $k$ is odd, just to the computation with a different twiddling factor and put it in the lower place, just as the blue lines.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/stage3even-480.webp 480w,/assets/img/2024-05-02-fft/stage3even-800.webp 800w,/assets/img/2024-05-02-fft/stage3even-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/stage3even.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-05-02-fft/stage3odd-480.webp 480w,/assets/img/2024-05-02-fft/stage3odd-800.webp 800w,/assets/img/2024-05-02-fft/stage3odd-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-05-02-fft/stage3odd.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> The contruction of butterfly diagram </div> <p>OK, now that’s where we save the computation time. Originally, on the $3rd$ stage we need calculate $N * N/2 (‘<em>’ and ‘+’)$. Now we only need to calculate(N ‘</em>’ and ‘+’).</p> <p>And actually the same thing can be applied to the $2^{nd}$ stage and $1^{st}$ stage.</p> <p>We finished! You can derive the $2^{nd}$ stage and $1^{st}$ stage and construct the butterfly diagram by your self!</p> <h2 id="broken-matrixs">Broken matrixs</h2> <p>DFT matrix<br/> [ \begin{bmatrix} \hat f_0 <br/> \hat f_1 <br/> \vdots <br/> \hat f_{N-1} <br/> \end{bmatrix} = \frac{1}{N} \begin{bmatrix} 1 &amp; 1 &amp; 1 &amp; \dots &amp; 1<br/> 1 &amp; W_N &amp; W_N^2 &amp; \dots &amp; W_N^{N-1} <br/> \vdots &amp; &amp; &amp; &amp; \vdots <br/> 1 &amp; W_{N-1} &amp; W_N^{2(N-1)} &amp; \dots &amp; W_N^{(N-1)^2} <br/> \end{bmatrix} \begin{bmatrix} f_0 <br/> f_1 <br/> \vdots <br/> f_{N-1} <br/> \end{bmatrix} ]</p> <p>Code for 8-point equation 1-8</p> <ul> <li>1</li> </ul> <p>[ \hat f[k] = \frac{1}{8}\sum_{n=0}^{7} e^{-\frac{2\pi ikn}{8}} = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{8}} + f[2]e^{-\frac{2\pi i 2* k}{8}} + f[4]e^{-\frac{2\pi i 4* k}{8}} + f[6]e^{-\frac{2\pi i 6* k}{8}} <br/> +f[1]e^{-\frac{2\pi i 1* k}{8}} +f[3]e^{-\frac{2\pi i 3* k}{8}} + f[5]e^{-\frac{2\pi i 5* k}{8}} + f[7]e^{-\frac{2\pi i 7* k}{8}} <br/> \end{matrix} ]</p> <ul> <li>2</li> </ul> <p>[ \hat f[k] = \frac{1}{8}\sum_{n=0}^{7} e^{-\frac{2\pi ikn}{8}} = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{8}} + f[2]e^{-\frac{2\pi i 2* k}{8}} + f[4]e^{-\frac{2\pi i 4* k}{8}} + f[6]e^{-\frac{2\pi i 6* k}{8}} <br/> +e^{-\frac{2\pi i k}{8}}(f[1]e^{-\frac{2\pi i 0* k}{8}} +f[3]e^{-\frac{2\pi i 2* k}{8}} + f[5]e^{-\frac{2\pi i 4* k}{8}} + f[7]e^{-\frac{2\pi i 6* k}{8}}) <br/> \end{matrix} ]</p> <ul> <li>3</li> </ul> <p>[ \hat f[k] = \frac{1}{8}\sum_{n=0}^{7} e^{-\frac{2\pi ikn}{8}} = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{8}} + f[4]e^{-\frac{2\pi i 4* k}{8}} <br/> + f[2]e^{-\frac{2\pi i 2* k}{8}} + f[6]e^{-\frac{2\pi i 6* k}{8}} <br/> +e^{-\frac{2\pi i k}{8}}(f[1]e^{-\frac{2\pi i 0* k}{8}} + f[5]e^{-\frac{2\pi i 4* k}{8}}) <br/> +e^{-\frac{2\pi i k}{8}}(f[3]e^{-\frac{2\pi i 2* k}{8}} + f[7]e^{-\frac{2\pi i 6* k}{8}}) <br/> \end{matrix} ]</p> <ul> <li>4</li> </ul> <p>[ \hat f[k] = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{4}} + f[4]e^{-\frac{2\pi i 2* k}{4}} <br/> + f[2]e^{-\frac{2\pi i 1* k}{4}} + f[6]e^{-\frac{2\pi i 3* k}{4}} <br/> +e^{-\frac{2\pi i k}{8}}(f[1]e^{-\frac{2\pi i 0* k}{4}} + f[5]e^{-\frac{2\pi i 2* k}{4}}) <br/> +e^{-\frac{2\pi i k}{8}}(f[3]e^{-\frac{2\pi i 1* k}{4}} + f[7]e^{-\frac{2\pi i 3* k}{8}}) <br/> \end{matrix} ]</p> <ul> <li>5</li> </ul> <p>[ \hat f[k] = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{4}} + f[4]e^{-\frac{2\pi i 2* k}{4}} <br/> + e^{-\frac{2\pi i k}{4}}[f[2]e^{-\frac{2\pi i 0* k}{4}} + f[6]e^{-\frac{2\pi i 2* k}{4}}] <br/> +e^{-\frac{2\pi i k}{8}}{f[1]e^{-\frac{2\pi i 0* k}{4}} + f[5]e^{-\frac{2\pi i 2* k}{4}}} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[f[3]e^{-\frac{2\pi i 0* k}{4}} + f[7]e^{-\frac{2\pi i 2* k}{4}}]} <br/> \end{matrix} ]</p> <ul> <li>6</li> </ul> <p>[ \hat f[k] = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{2}} + f[4]e^{-\frac{2\pi i 1* k}{2}} <br/> + e^{-\frac{2\pi i k}{4}}[f[2]e^{-\frac{2\pi i 0* k}{2}} + f[6]e^{-\frac{2\pi i 1* k}{2}}] <br/> +e^{-\frac{2\pi i k}{8}}{f[1]e^{-\frac{2\pi i 0* k}{2}} + f[5]e^{-\frac{2\pi i 1* k}{2}}} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[f[3]e^{-\frac{2\pi i 0* k}{2}} + f[7]e^{-\frac{2\pi i 1* k}{2}}]} <br/> \end{matrix} ]</p> <ul> <li>7</li> </ul> <p>[ \hat f[k] = \begin{matrix} f[0]e^{-\frac{2\pi i 0* k}{1}} <br/> +e^{-\frac{2\pi i 1* k}{2}} * f[4]e^{-\frac{2\pi i 0* k}{1}} <br/> + e^{-\frac{2\pi i k}{4}}[f[2]e^{-\frac{2\pi i 0* k}{1}}] <br/> + e^{-\frac{2\pi i k}{4}}[ e^{-\frac{2\pi i 1* k}{2}} * f[6]e^{-\frac{2\pi i 0* k}{1}}] <br/> +e^{-\frac{2\pi i k}{8}}{f[1]e^{-\frac{2\pi i 0* k}{1}}} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i 1* k}{2}} * f[5]e^{-\frac{2\pi i 0* k}{1}}} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[f[3]e^{-\frac{2\pi i 0* k}{1}}]} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[e^{-\frac{2\pi i 1* k}{2}} f[7]e^{-\frac{2\pi i 0* k}{1}}]} <br/> \end{matrix} ]</p> <ul> <li>8</li> </ul> <p>[ \hat f[k] = \begin{matrix} f[0] <br/> +e^{-\frac{2\pi i 1* k}{2}} * f[4] <br/> + e^{-\frac{2\pi i k}{4}}[f[2]] <br/> + e^{-\frac{2\pi i k}{4}}[ e^{-\frac{2\pi i 1* k}{2}} * f[6]] <br/> +e^{-\frac{2\pi i k}{8}}{f[1]} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i 1* k}{2}} * f[5]} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[f[3]]} <br/> +e^{-\frac{2\pi i k}{8}}{e^{-\frac{2\pi i k}{4}}[e^{-\frac{2\pi i 1* k}{2}} f[7]]} <br/> \end{matrix} ]</p> <ul> <li>9</li> </ul> <p>[ \hat f[k] = \begin{matrix} &amp; f[0] &amp; &amp; &amp; <br/> + &amp; f[4] &amp; <em>e^{-\frac{2\pi i k}{2}}&amp; &amp; <br/> + &amp; f[2]&amp; &amp; * e^{-\frac{2\pi i k}{4}} &amp; <br/> + &amp; f[6] &amp;</em>e^{-\frac{2\pi i k}{2}}&amp; <em>e^{-\frac{2\pi i k}{4}} &amp; <br/> + &amp; f[1] &amp; &amp; &amp; *e^{-\frac{2\pi i k}{8}}<br/> + &amp; f[5] &amp; *e^{-\frac{2\pi i k}{2}}&amp; &amp; *e^{-\frac{2\pi i k}{8}}<br/> + &amp; f[3]&amp; &amp; * e^{-\frac{2\pi i k}{4}} &amp; *e^{-\frac{2\pi i k}{8}}<br/> + &amp; f[7] &amp;</em>e^{-\frac{2\pi i k}{2}}&amp; *e^{-\frac{2\pi i k}{4}} &amp; *e^{-\frac{2\pi i k}{8}}<br/> \end{matrix} ]</p>]]></content><author><name></name></author><category term="algorithms"/><category term="advanced-transforms"/><category term="algorithms"/><summary type="html"><![CDATA[When learning this topic, I encountered a problem regarding the Twiddle Factor and the butter fly diagram. Here is my explanation with a derivation of 8 point example.]]></summary></entry><entry><title type="html">Can high voltage battery shocks a man?How? 一块高压蓄电池能否以及如何让人中电?</title><link href="https://toflamus.github.io/blog/2024/battery-and-GND/" rel="alternate" type="text/html" title="Can high voltage battery shocks a man?How? 一块高压蓄电池能否以及如何让人中电?"/><published>2024-04-28T21:25:00+00:00</published><updated>2024-04-28T21:25:00+00:00</updated><id>https://toflamus.github.io/blog/2024/battery-and-GND</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/battery-and-GND/"><![CDATA[<p>今天在看L.Plett的BMS书，Vol2 电池安全防护这一节（1.7）。突然让我重新回忆起一个困扰我许久的问题。</p> <blockquote> <p>假设一个人手握一个12V的电池的正负极的任意一级光脚站在地上。它感受到的电压是多少？握在正极和负极的感受到的电压一样吗？btw 这里我主要是想讨论中电问题，也就是说一个人是否会因为触摸高电压电池而中电。</p> </blockquote> <p>我之前所想的是：</p> <ul> <li>一块高压蓄电池的电压的主要部分是由物理化学规律决定的，那么这个电压就是一个相对电压，我无法得到某个电极的绝对电压。因此也无法衡量一个电极和大地的电势差，也无法根据36V安全定律来判断是否会安全。</li> <li>并且因为人和电池没有形成回路，那么如何放电。</li> </ul> <p>然而在朋友圈进行询问之后不久便得到了一个答案，醍醐灌顶：</p> <blockquote> <p>你把它想象成电容就好理解了,12V只是两块板之间的电压差，而你感受的电压跟你手中那块极板到地面的距离，还有各种其他因素决定，不是固定的。<br/> ——来自Magdalen的好兄弟</p> </blockquote> <p>从[C = \frac{\epsilon S}{d}] 上来讲，因为距离很远，面积很小，所以电容基本上是0，[U = Q/C] 所以电压可能会很大，但是因为电荷是非常少的，所以电压也不会大到离谱的地步。</p> <p>电容解释非常中肯，在真实的电池体系中也会出现Double layer capacitance。在电极材料表面就会充电。电池的充放电的回路要求是建立在基尔霍夫定律上的。就是说电荷守恒的条件，但是这个条件在带电体的形况下不满足。</p> <p>这不禁让我回想起初中时的测量物体是否带电的实验。摩擦毛皮和玻璃棒让后放到测电器的金属球上面，测电器的金属箔片会打开一个小张角，证明玻璃棒带电。</p>]]></content><author><name></name></author><category term="battery-study"/><category term="batteries"/><category term="insights"/><category term="shortposts"/><category term="chinese"/><summary type="html"><![CDATA[A interesting problem regarding a man holding battery electrode and standing on the ground.一个关于高压蓄电池如何让人中电的有趣问题。]]></summary></entry><entry><title type="html">Hysteresis voltage modeling</title><link href="https://toflamus.github.io/blog/2024/Hysteresis-voltage/" rel="alternate" type="text/html" title="Hysteresis voltage modeling"/><published>2024-04-27T14:25:00+00:00</published><updated>2024-04-27T14:25:00+00:00</updated><id>https://toflamus.github.io/blog/2024/Hysteresis-voltage</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/Hysteresis-voltage/"><![CDATA[<h2 id="hysteresis-voltage">Hysteresis voltage</h2> <p>Definition: OCV-SOC curves for charging and discharging Li-ion batteries do not overlap. The difference between the curves is defined as <em>Hysteresis voltage</em>.</p> <p>The modeling can be physics-based or phenomenon-based.</p> <p>I find the modeling of hysteresis is a deep field because the hysteresis phenomenon can happen in various disciplines. There is even a book about hysteresis modeling<d-cite key="hysteresismodelingmath"></d-cite>. There are plenty of different models to model a hysteresis, such as Prandtl-Ishlinskii hysteresis model<d-cite key="4739202"></d-cite>(This is a topic in control engineering). However, they are not covered in this blog post. I just put them here for further reference. The main framework is still from L. Plett’s book.<d-cite key="BMS_vol1"></d-cite></p> <h2 id="main-loop-and-minor-loop">Main loop and minor loop</h2> <p>This part is mainly from the Guillaume Larrat’s thesis. <d-cite key="Lihysteresismodeling"></d-cite></p> <p>The charging and discharging OCV curves that were displayed in the figure below allows to create a voltage hysteresis loop for a SOC varying from 0% to 100% which includes the whole range of possible values for the SOC.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/OCV_curve-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/OCV_curve-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/OCV_curve-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/OCV_curve.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>It is composed of the two <strong>major</strong> OCV curves: a charge from 0% to 100% SOC and a full discharge from 100% to 0%. The corresponding voltage hysteresis loop is then called a major loop. However, if the cell is partially charged or discharged from a state different than 0% or 100%, the OCV will not follow the two curves displayed earlier. If a cell is at a 60% SOC and is then discharged to 40% and then charged back to 60%, this will create a minor loop as shown in Figure below:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/major_minor_loop-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/major_minor_loop-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/major_minor_loop-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/major_minor_loop.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Assupmtion: The loop of a real-time charge/discharge process only locates insides the major loop. Apparently, the changing rate in a minor loop is different from the major loop.</p> <h2 id="hysteresis-modeling">Hysteresis modeling</h2> <p>Let’s just build a simple model:<br/> Assumptions:</p> <ul> <li>Linear: The changing rate of hysteresis voltage only depends the difference between maxium OCV and current OCV.</li> <li>Past path invariant: The hyseresis does not depend on how to get to the state but just and past state themselves. Actually, this is not true.</li> </ul> <p>\(h(z(t)) = OCV_{charge}(z(t))-OCV_{discharge}(z(t))\) \(\frac{dh(z,t)}{dz} = \gamma sgn(\dot z)(M(z,\dot z)- h(z,t))\)</p> <p>$\gamma$ is just a coefficient for linear approximation.<br/> $M(z,\dot z)$: A function that gives the maximum polarization due to the hysteresis as a function of SOC and rate of charge.<br/> $M(z,\dot z)- h(z,t)$: Indicates that the rate of change of the hysteresis voltage is proportional to the distance of the current hysteresis value from the main hysteresis loop. In other words, the driving force decides the rate of change.<br/> $z(t)$ defines the changing direction of the hysteresis. For charging process, $\dot z &gt; 0$, which means hysteresis tends to be larger, this means the $$OCV_{charge}(z(t))$ tends to be closer to the maximum OCV.</p> <p>Because our previous equivalent circuit model depends on the time, we use the chain rule to make the differencial equation a function of time.</p> \[\frac{dh(z,t)}{dz} \frac{dz}{dt} = \gamma sgn(\dot z)(M(z,\dot z)- h(z,t)) \frac{dz}{dt}\] <p>\(\frac{dz}{dt} = -\eta(t)i(t)/Q\) $\dot z sgn(\dot z) = |z|$</p> \[\frac{dh(z,t)}{dz} \frac{dz}{dt} = \gamma (M(z,\dot z)- h(z,t)) *|\frac{\eta(t)i(t)}{Q}|\] <p>To make life easier <strong>assume $I(t)$ &amp; $M(z,\dot z)$ are constant during sampling period</strong>. So if one want to get the fully profile, multiple linear approximation can be made to tackle this problem.</p> <p>Solve the ODE and make it discrete, and do some rearrangements:</p> \[h[s+1] = exp(-|\frac{\eta[s]I\Delta t\gamma}{Q}|)h[s] + M(z,\dot z)(1-exp(-|\frac{\eta[s]I\Delta t\gamma}{Q}|))\] <p>Note: $M(z,\dot z) $ varies with current orientation, the simplest way to make it a const is by $M(z,\dot z) = -M sgn(i(t))$</p> <p>Now the equation becomes:</p> \[h[s+1] = exp(-|\frac{\eta[s]I\Delta t\gamma}{Q}|)h[s] - Msgn(i(t))(1-exp(-|\frac{\eta[s]I\Delta t\gamma}{Q}|))\] <table> <tbody> <tr> <td>$A_H[s] = exp(-</td> <td>\frac{\eta[s]I\Delta t\gamma}{Q}</td> <td>)$</td> </tr> </tbody> </table> \[h[s+1] = A_H h[s] - Msgn(i(t))(1-A_H)\] <p>We can normalize the result by devide the equation by $M$.</p> <p>\(\hat h[s+1] = A_H \hat h[s] - sgn(i(t))(1-A_H)\) \(Hysteresis voltage = M\hat h[s]\)</p> <p>Now this model can be viewed as a linear model <em>dynamic hysteresis</em> that goes through the origin point. However, in reality it is a good idea to model a const in case the curve do not fit the origin. The const is called <em>instaneous hysteresis</em>. It also contains the information when the current direction changes.</p> <p>[ \hat h_{ins}[s] = \begin{matrix} sgn(i[s]), |i[s]|&gt;0<br/> \hat h_{int}[s-1], otherwise.<br/> \end{matrix} ]</p> <p>The <em>instaneous hysteresis</em> is:</p> \[Instaneous hysteresis = M_0 \hat h_{int}[s]\] <h2 id="enhanced-self-correcting-esc-model">Enhanced self-correcting (ESC) model</h2> <p><em>Enhanced</em> means the model also includes hysteresis effects.<br/> <em>Self-correcting</em> means the model converges to the $OCV+hysteresis$ when $i = 0$</p> <p>From the discussion on equivalant circuit models, now with new information with hysteresis effects. The OCV with half cell equivalent circuit can be viewed as follows:</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/circuit1-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/circuit1-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/circuit1-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/circuit1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> half-cell with OCV and hysteresis </div> <p>When the time scale difference bewteen Warburg impedance and other circuit elements are so large, that the Warburg impedance get out on to the main branch.</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/circuit2-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/circuit2-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/circuit2-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/circuit2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> approximation of half-cell with OCV and hysteresis. </div> <p>As we have discussed in another blog the linear part of Warburg impedance can be approximated by a series of parallel resistor-and-capacitor pairs.</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/circuit3-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/circuit3-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/circuit3-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/circuit3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Let’s denote the charge transfer resistance and double layer capacity as $R_{0}$ and $C_{0}$</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/circuit4-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/circuit4-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/circuit4-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/circuit4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h3 id="single-resistor-and-capacitor-pair">Single resistor-and-capacitor pair</h3> <p>Let’s use the current to analyze a resistor-and-capacitor pair.</p> <p>For a single pair, use the voltage change of a single resistor-and-capacitor pair as a birdge:</p> <p>\(u_k = \frac{Q_k}{C_k} = \frac{1}{C_k}\int_0^t I-i_k dt\) \(u_k = R_k i_k\)</p> <p>where $i_k$ is the current goes through $R_k$ and I is main branch current.</p> <p>After take a derivative and rearrangement:</p> \[i_k(t) + \frac{i(t)}{C_kR_k} = \frac{I(t)}{C_kR_k}\] <p>Solve the ODE using Cauchy’s method.</p> \[i_k(t) = Ae^{-\frac{t}{C_kR_k}} + i_c(t)\] <p>When in reality, the I(t) can be AC current such as in the case of (EIS). So it can be extended to a fourier series. This means the solution of the ODE is also a fourier series, denoted $i_c(t) = I’(t)$.</p> <p>Now let’s think about the discret form.</p> <p>\(i_k[s] = Ae^{-\frac{s\Delta t}{C_kR_k}} + i_c[s]\) \(i_k[s+1] = Ae^{-\frac{(s+1)\Delta t}{C_kR_k}} + i_c[s+1]\)</p> <p>Then:</p> <p>\(i_k[s+1] = F_k * i_k[s] + i_c[s+1] - F_k i_c[s]\) \(F_k = e^{-\frac{\Delta t}{C_kR_k}}\)</p> <p>To make life easier <strong>assume I(t) is a constant during sample period</strong>. So if one want to get the fully profile, multiple linear approximation can be made to tackle this problem.</p> \[i_c[s] = i_c[s+1] = I\] <p>The original solution becomes:<br/> \(i_k[s+1] = F_k * i_k[s] + (1- F_k)I\)</p> <p>Convert this equation to a matrix form:</p> <p>\(\vec i_r[s+1] = \mathbb A_{RC} * \vec i_r[s] + b_{RC} I\) \(\mathbb A_{RC} = diag(F_k)\) \([\vec b_{RC}]_i = 1-F_i\)</p> <h3 id="esc-model-and-its-state-equation">ESC model and its <em>state equation</em></h3> <p>Combine everything above together, we get the <em>state equation</em> of ESC model</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/SCM-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/SCM-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/SCM-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/SCM.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>The voltage of the model is estimated by:</p> \[v[s] = OCV(z[s],T[s]) + M\hat h[s] + M_0 \hat h_{int}[s] - \sum_j^n R_ji_{R_j}[s] -R_u i[s]\] <h2 id="afterwords">Afterwords</h2> <h3 id="soc-method-to-analysis-the-circuit">SOC method to analysis the circuit</h3> <p>When considering the voltage of each resistor-and-capacitor pair,the ODE for a single resistor-and-capacitor pair is:</p> \[\dot u_i = -\frac{1}{R_i C_i} u_i + \frac{1}{C_i} I\] <p>The ODEs for resistor-and-capacitor pairs can be expressed as:</p> <div class="row mt-3"> <div class="col-sm mt-4 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-27-Hysteresis-voltage/SOC-480.webp 480w,/assets/img/2024-04-27-Hysteresis-voltage/SOC-800.webp 800w,/assets/img/2024-04-27-Hysteresis-voltage/SOC-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-27-Hysteresis-voltage/SOC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>This is the method with voltage to describe the SOC but however I need to use current instead of voltage to analyze the circuit here.</p> <h3 id="somenotes">Somenotes</h3> <p>My matrix was inappropriately deployed for some reasons. I just used a <code class="language-plaintext highlighter-rouge">.png</code> instead. Here is the original matrix.</p> <p>For SCM:</p> <p>[ \begin{bmatrix} z[s+1] \<br/> \vec i_r[s+1] \<br/> h[s+1]\<br/> \end{bmatrix} = \begin{bmatrix} 1 &amp; 0 &amp; 0\<br/> 0 &amp; \mathbb A_{RC} &amp; 0 \<br/> 0 &amp; 0 &amp; A_H\<br/> \end{bmatrix} \begin{bmatrix} z[s]\<br/> \vec i_r[s]\<br/> h[s]\<br/> \end{bmatrix} + \begin{bmatrix} -\frac{\eta [s] \Delta t}{Q} &amp; 0\<br/> \vec b_{RC} &amp; 0 \<br/> 0 &amp; A_H-1 \<br/> \end{bmatrix} \begin{bmatrix} I \<br/> sgn(I)\<br/> \end{bmatrix} ]</p> <p>For SOC method: \begin{equations} \begin{bmatrix} \dot u_0<br/> \dot u_1<br/> \vdots<br/> \dot u_n<br/> \end{bmatrix} = \begin{bmatrix} -\frac{1}{C_0R_0} &amp; 0 &amp; \cdots &amp; 0 <br/> 0 &amp; -\frac{1}{C_1R_1} &amp; \cdots &amp; 0 <br/> \vdots &amp; 0 &amp; \cdots &amp; 0 <br/> 0 &amp; \cdots &amp; 0 &amp; -\frac{1}{C_nR_n}<br/> \end{bmatrix} \begin{bmatrix} u_0<br/> u_1<br/> \vdots<br/> u_n<br/> \end{bmatrix} + \begin{bmatrix} \frac{1}{C_0}<br/> \frac{1}{C_1}<br/> \vdots<br/> \frac{1}{C_n}<br/> \end{bmatrix} I \end{equations} I did not heard about this topic too much before when I concentrated at ElectroChemistry. The hysteresis effect is important for Battery Management Systems.</p>]]></content><author><name></name></author><category term="battery-study"/><category term="batteries"/><category term="longposts"/><category term="lithium-ion"/><summary type="html"><![CDATA[Simple introduce hysteresis voltage and its phenomenological modeling]]></summary></entry><entry><title type="html">Build an equivalent circuit of batteries from scratch</title><link href="https://toflamus.github.io/blog/2024/equivalent-circuit-of-batteries/" rel="alternate" type="text/html" title="Build an equivalent circuit of batteries from scratch"/><published>2024-04-26T14:25:00+00:00</published><updated>2024-04-26T14:25:00+00:00</updated><id>https://toflamus.github.io/blog/2024/equivalent-circuit-of-batteries</id><content type="html" xml:base="https://toflamus.github.io/blog/2024/equivalent-circuit-of-batteries/"><![CDATA[<p>This blog is a summary of the problems and concerns one may encounter when consider the battery system. Detailed but not essential formulas are not included. This blog is just a general description.</p> <h2 id="open-circuit-voltageocv-and-state-of-chargesoc-dependence-">Open circuit voltage(OCV) and State of Charge(SOC) dependence <d-cite key="BMS_vol1"></d-cite></h2> <p>The first thing one thinks to build a equivalent circuit is to ADD a <em>voltage source</em> to the circuit. From high school physics, the <em>open circuit voltage</em> is supposed to be the voltage at infinite large load, which means the current density is approximately zero. I previously thinks that the OCV may related to current density, diffusion, kinetics. However, I misunderstood the concept of OCV it is not working. Ideally there is no current, consequently no diffusion and kinetics problems. It should be more stable then I had thought.</p> <p>Nonetheless, it is by no means stationary. From Nernst equation:</p> <p>\(\Delta G = -zFE\) \(E = E^\circ - \frac{RT}{zF}ln(Q_r)\)</p> <p>with the ongoing of reaction the activity is also changed. OK, one may argue that in a <s> rockin' roll </s> the <em>rocking chair battery(RCB)</em> the solvent concentration may not change, just like their famous relative of RCB: <em>Lithium-ion batteries(LIBs)</em>. However, I still thinks SEI formation, surface reshaping, and other side effects may drive the OCV away when using the battery. So here we introduce an important concept called <em>State of Charge(SOC)</em>. This should actually mean the charge status, like SOC = 100% means fully charged. Just like the worrying battery percentage thing in your cellphone. OK, I have to admit this really confused me for several days when I first get to know the concept, because nobody told me the UNIT of SOC(unit of 1). I find people directly use the voltage in a capacitor to be the SOC and this works because ideal capacitors have a linear relationship between voltage and remaining charges.</p> <p>So now we have a circuit with a SOV dependent OCV.</p> <p>By the way, one may come up with the question: <strong>How to test the SOC and OCV relationships?</strong>. Naturally, we may think of a simple method that we charge/discharge the battery to different SOC and wait it to reach equilibrium. This technique is called <em>Galvanostatic internmittent titration test(GITT)</em>. The method involves a small charge/discharge and then a long rest period to allow the cell to equilibrate. Then the voltages at the end of the periods are taken as the OCV. <d-cite key="C26_2"></d-cite></p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-04-26-equivalent-circuit-of-batteries/GITT-480.webp 480w,/assets/img/2024-04-26-equivalent-circuit-of-batteries/GITT-800.webp 800w,/assets/img/2024-04-26-equivalent-circuit-of-batteries/GITT-1400.webp 1400w," sizes="95vw" type="image/webp"/> <img src="/assets/img/2024-04-26-equivalent-circuit-of-batteries/GITT.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Here is an typical graphic example of GITT<d-cite key="LIBOCVmodel"></d-cite> </div> <p>Now we can model the SOC(denoted by $z(t)$) with continuous and discrete form by differential and difference equations. Assuming that discharge current is positive.</p> <ul> <li>Continuous form: <ul> <li>$\dot z(t) = -\eta(t)i(t)/Q$</li> <li>$z(t) =z(0) -\frac{1}{Q} \int_0^t \eta(\tau)i(\tau)$</li> </ul> </li> <li>Discrete form: <ul> <li>$z[k+1] = z[k] - \frac{\Delta t}{Q}\eta[k]i[k]$</li> </ul> </li> </ul> <p>Some other concepts and their definitions:</p> <ul> <li><em>total charge capacity(total capacity) $Q$</em>: total charge removed from SOC = 100% to SOC = 0%</li> <li><em>discharge capacity</em>: total charge removed from SOC = 100% to some cut off voltage where SOC &gt; 0%.</li> <li><em>depth of discharge(DOD)</em>: $DOD = 1 - SOC$</li> </ul> <p>OK now I am gonna say that what has been built above is straight forward but a lot too simple.There are a lot of things to be taken into account. <em>Randles circuit</em>, <em>Warburg impedence</em></p> <p>##</p> <hr/> <h2 id="small-talks">Small talks</h2> <blockquote> <p>At winter, the electric car can be driven for less distance not only because the inner resitance of bateries become larger, but also because there is 7% larger air resistance at 5 C compared with 25 C. —My kindly lecturer of C26</p> </blockquote>]]></content><author><name></name></author><category term="battery-study"/><category term="batteries"/><category term="longposts"/><summary type="html"><![CDATA[First blog!]]></summary></entry></feed>